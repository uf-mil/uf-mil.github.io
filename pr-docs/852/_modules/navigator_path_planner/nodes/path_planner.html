<!DOCTYPE html>
<!-- Some pieces of this template were used from https://github.com/Rapptz/discord.py/blob/master/docs/_templates/layout.html -->
<html>
    <head>
        <!-- HTML meta -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale: 1.0">
        <title>navigator_path_planner.nodes.path_planner</title>
        <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
        <link rel="stylesheet" href="../../../_static/codeblocks.css" type="text/css" />
        <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
        <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../searchindex.js" defer></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script src="../../../_static/custom.js"></script>
        <script src="../../../_static/sidebar.js"></script>
        <script src="../../../_static/lightdarkmode.js"></script>
        <link rel="shortcut icon" href="../../../_static/mil_white.svg"/>
        <link rel="index" title="Index" href="../../../genindex.html" />
        <link rel="search" title="Search" href="../../../search.html" />
    </head>
    <body>
        <div class="main-grid">
            <header class="grid-item">
                <nav>
                    <a class="main-heading" href="../../../index.html">Machine Intelligence Lab</a>
                    <div id="mil-light-dark-icon" onClick="rotateLightDark();">
                        <span class="material-icons" title=""></span>
                    </div>
                    <a href="https://github.com/uf-mil/mil" target="_blank"><img class="mil-svg" src="../../../_static/github.svg" /></a>
                    <a href="https://mil.ufl.edu" target="_blank"><img class="mil-svg" src="../../../_static/mil.svg" /></a>
                </nav>
            </header>
            <aside class="grid-item">
                <span id="hamburger-toggle">
                    <span class="material-icons">menu</span>
                </span>
                <div id="sidebar"><form id="search-form" role="search" class="search" action="../../../search.html" method="get">
    <div class="search-wrapper">
        <input type="search" name="q" placeholder="Search documentation" />
        <button type="submit" onmousedown="searchBarClick(event, document.getElementById('search-form'));">
            <span class="material-icons">search</span>
        </button>
    </div>
</form>
<h3><a href="../../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../welcome.html">Welcome to MIL!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mechanical/index.html">Mechanical</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../electrical/index.html">Electrical</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software/index.html">Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../subjugator/index.html">SubjuGator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../navigator/index.html">NaviGator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Software Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../subjugator/reference.html">Subjugator Software Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../navigator/reference.html">Navigator Software Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infrastructure/index.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../culture.html">Culture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../branding.html">Branding</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testingprocedures.html">Testing Procedures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deprecated.html">Deprecated Projects</a></li>
</ul>

                </div>
            </aside>
            <main class="grid-item" role="main">
                
  <h1>Source code for navigator_path_planner.nodes.path_planner</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">ModuleType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">actionlib</span>
<span class="kn">import</span> <span class="nn">cv2</span>  <span class="c1"># for occupancy grid analysis</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">npl</span>
<span class="kn">import</span> <span class="nn">rospy</span>

<span class="c1"># Check scipy version for assume_sorted argument in interp1d</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">import</span> <span class="nn">tf.transformations</span> <span class="k">as</span> <span class="nn">trns</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Point32</span><span class="p">,</span>
    <span class="n">PointStamped</span><span class="p">,</span>
    <span class="n">PolygonStamped</span><span class="p">,</span>
    <span class="n">Pose</span><span class="p">,</span>
    <span class="n">PoseArray</span><span class="p">,</span>
    <span class="n">PoseStamped</span><span class="p">,</span>
    <span class="n">WrenchStamped</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mil_tools</span> <span class="kn">import</span> <span class="n">numpy_to_quaternion</span>
<span class="kn">from</span> <span class="nn">nav_msgs.msg</span> <span class="kn">import</span> <span class="n">OccupancyGrid</span><span class="p">,</span> <span class="n">Odometry</span>
<span class="kn">from</span> <span class="nn">navigator_path_planner</span> <span class="kn">import</span> <span class="n">boat</span><span class="p">,</span> <span class="n">car</span><span class="p">,</span> <span class="n">escape</span><span class="p">,</span> <span class="n">params</span>
<span class="kn">from</span> <span class="nn">navigator_path_planner.msg</span> <span class="kn">import</span> <span class="n">MoveAction</span><span class="p">,</span> <span class="n">MoveFeedback</span><span class="p">,</span> <span class="n">MoveGoal</span><span class="p">,</span> <span class="n">MoveResult</span>

<span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">interp1d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;assume_sorted&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">interp1d</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span>

<span class="c1"># INITIALIZATIONS</span>


<div class="viewcode-block" id="LQRRT_Node"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node">[docs]</a><span class="k">class</span> <span class="nc">LQRRT_Node</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example of a ROS node that uses lqRRT for a big boat.</span>

<span class="sd">    This node subscribes to the current boat state (Odometry message),</span>
<span class="sd">    and the world-frame ogrid (OccupancyGrid message). It publishes the</span>
<span class="sd">    REFerence trajectory that moves to the goal, as an Odometry message.</span>
<span class="sd">    It provides an action for moving said reference to that goal (Move.action).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        revisit_period (float): When to refresh the core of the planner.</span>
<span class="sd">        ref_pub (rospy.Publisher): The publisher serving the lqRRT reference</span>
<span class="sd">            topic name.</span>
<span class="sd">        path_pub (rospy.Publisher): Publisher responsible for publishing a PoseArray</span>
<span class="sd">            to the provided path topic.</span>
<span class="sd">        tree_pub (rospy.Publisher): Publisher responsible for publishing a PoseArray</span>
<span class="sd">            to the provided tree topic.</span>
<span class="sd">        unreachable (bool): Whether the planner sees a goal as being unreachable.</span>
<span class="sd">            Defaults to ``false``.</span>
<span class="sd">        done (bool): Whether the planner has finished its movement. Defaults to ``false``.</span>
<span class="sd">        move_type (MoveAction): How the boat is planning to move towards its goal.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">odom_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ref_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">move_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">path_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tree_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">goal_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">focus_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">effort_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ogrid_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ogrid_threshold</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize with topic names and ogrid threshold as applicable.</span>
<span class="sd">        Defaults are generated at the ROS params level.</span>

<span class="sd">        Args:</span>
<span class="sd">            odom_topic (str): The name of the topic supplying Odometry</span>
<span class="sd">              messages.</span>
<span class="sd">            ref_topic (str): The lqRRT reference topic name.</span>
<span class="sd">            move_topic (str): The name of the topic hosting the SimpleActionServer</span>
<span class="sd">              and topic of where to move to.</span>
<span class="sd">            path_topic (str): The name of the lqRRT path topic name.</span>
<span class="sd">            tree_topic (str): The name of the topic holding the lqRRT tree.</span>
<span class="sd">            goal_topic (str): The name of the topic holding the lqRRT goal.</span>
<span class="sd">            focus_topic (str): The name of the topic holding the lqRRT focus.</span>
<span class="sd">            effort_topic (str): The name of the topic hosting the lqRRT effort</span>
<span class="sd">              wrenches.</span>
<span class="sd">            ogrid_topic (str): The name of the topic holding the occupancy grid.</span>
<span class="sd">            ogrid_threshold (str): An occupancy grid cell which exceeds this</span>
<span class="sd">              value will be marked as filled. The value will be converted to</span>
<span class="sd">              a float in the class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># One-time initializations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revisit_period</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ogrid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ogrid_threshold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Lil helpers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rostime</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intup</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_hood</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">img</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="n">img</span><span class="p">[</span><span class="n">row</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">row</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">col</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Set-up planners</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">car</span><span class="p">,</span> <span class="n">boat</span><span class="p">,</span> <span class="n">escape</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_list</span><span class="p">:</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">set_system</span><span class="p">(</span><span class="n">erf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">erf</span><span class="p">)</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">set_runtime</span><span class="p">(</span><span class="n">sys_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">)</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">set_feasibility_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">)</span>

        <span class="c1"># Initialize resettable stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># Subscribers</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="n">odom_topic</span><span class="p">,</span> <span class="n">Odometry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">odom_cb</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="n">ogrid_topic</span><span class="p">,</span> <span class="n">OccupancyGrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_cb</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Publishers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="n">ref_topic</span><span class="p">,</span> <span class="n">Odometry</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="n">path_topic</span><span class="p">,</span> <span class="n">PoseArray</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="n">tree_topic</span><span class="p">,</span> <span class="n">PoseArray</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="n">goal_topic</span><span class="p">,</span> <span class="n">PoseStamped</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focus_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="n">focus_topic</span><span class="p">,</span> <span class="n">PointStamped</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eff_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="n">effort_topic</span><span class="p">,</span> <span class="n">WrenchStamped</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampspace_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span>
            <span class="n">sampspace_topic</span><span class="p">,</span> <span class="n">PolygonStamped</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guide_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="n">guide_topic</span><span class="p">,</span> <span class="n">PointStamped</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionServer</span><span class="p">(</span>
            <span class="n">move_topic</span><span class="p">,</span> <span class="n">MoveAction</span><span class="p">,</span> <span class="n">execute_cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">move_cb</span><span class="p">,</span> <span class="n">auto_start</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Timers</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revisit_period</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">publish_ref</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">revisit_period</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_check</span><span class="p">)</span>

<div class="viewcode-block" id="LQRRT_Node.reset"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets variables that should definitely be cleared before a new action begins.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Internal plan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_eff</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_seq</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u_seq</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dt</span>

        <span class="c1"># Behavior control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enroute_behavior</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_bias</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guide</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Planning control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_plan_time</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">basic_duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blind</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Issue control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stuck</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stuck_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_till_issue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preempted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unreachable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collided</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Unkill all planners</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_tree</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_list</span><span class="p">:</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">unkill</span><span class="p">()</span></div>

    <span class="c1"># ACTION</span>
<div class="viewcode-block" id="LQRRT_Node.move_cb"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.move_cb">[docs]</a>    <span class="k">def</span> <span class="nf">move_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">MoveAction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback for the move action.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (MoveAction): The action passed by the action client.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[bool]: ???</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start clean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

        <span class="c1"># Make sure odom is publishing (well, at least once)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot plan until odom is received!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">set_aborted</span><span class="p">(</span><span class="n">MoveResult</span><span class="p">(</span><span class="s2">&quot;odom&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Give desired pose to everyone who needs it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_goal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unpack_pose</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">goal</span><span class="p">))</span>

        <span class="c1"># Check given move_type</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">move_type</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">MoveGoal</span><span class="o">.</span><span class="n">HOLD</span><span class="p">,</span>
            <span class="n">MoveGoal</span><span class="o">.</span><span class="n">DRIVE</span><span class="p">,</span>
            <span class="n">MoveGoal</span><span class="o">.</span><span class="n">DRIVE_SMOOTH</span><span class="p">,</span>
            <span class="n">MoveGoal</span><span class="o">.</span><span class="n">SKID</span><span class="p">,</span>
            <span class="n">MoveGoal</span><span class="o">.</span><span class="n">SPIRAL</span><span class="p">,</span>
            <span class="n">MoveGoal</span><span class="o">.</span><span class="n">BYPASS</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">blind</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blind</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing: blind </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">move_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">move_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">move_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported move_type: &#39;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">move_type</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">set_aborted</span><span class="p">(</span><span class="n">MoveResult</span><span class="p">(</span><span class="s2">&quot;move_type&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Station keeping move</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">HOLD</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_goal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span>
            <span class="n">remain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">remain</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">set_succeeded</span><span class="p">(</span><span class="n">MoveResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Bypass move</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">BYPASS</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">blind</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span>
                <span class="n">remain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">remain</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">set_succeeded</span><span class="p">(</span><span class="n">MoveResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Goal infeasible! Bypass move rejected.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">set_aborted</span><span class="p">(</span><span class="n">MoveResult</span><span class="p">(</span><span class="s2">&quot;occupied&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Make sure we are not already in a collided state</span>
        <span class="c1"># if not self.is_feasible(self.state, np.zeros(3)) and not self.blind:</span>
        <span class="c1">#    print(&quot;\nCan&#39;t move. Already collided.\n&quot;)</span>
        <span class="c1">#    self.move_server.set_aborted(MoveResult(&#39;collided&#39;))</span>
        <span class="c1">#    self.done = True</span>
        <span class="c1">#    return False</span>

        <span class="c1"># Check given focus</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">SKID</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">focus</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">boat</span><span class="o">.</span><span class="n">focus</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">focus_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pack_pointstamped</span><span class="p">([</span><span class="mf">1e6</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">],</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boat</span><span class="o">.</span><span class="n">focus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">msg</span><span class="o">.</span><span class="n">focus</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">focus</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">focus_vec</span> <span class="o">=</span> <span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">focus_goal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
                <span class="n">focus_goal</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">focus_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">focus_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_goal</span><span class="p">(</span><span class="n">focus_goal</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">focus_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pack_pointstamped</span><span class="p">(</span><span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">,</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Focused on: </span><span class="si">{</span><span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">SPIRAL</span><span class="p">:</span>
            <span class="n">boat</span><span class="o">.</span><span class="n">focus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">msg</span><span class="o">.</span><span class="n">focus</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">focus</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">focus</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">focus_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pack_pointstamped</span><span class="p">(</span><span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">,</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Focused on: </span><span class="si">{</span><span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">, counterclockwise&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Focused on: </span><span class="si">{</span><span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">, clockwise&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">boat</span><span class="o">.</span><span class="n">focus</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">focus_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pack_pointstamped</span><span class="p">([</span><span class="mf">1e6</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">],</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="p">)</span>

        <span class="c1"># Store the initial planning time, if specified</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">initial_plan_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial plan time: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">initial_plan_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_plan_time</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">initial_plan_time</span>

        <span class="c1"># Apply the speed factor, if specified</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">speed_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">speed_factor</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">speed_factor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">speed_factor</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;(WARNING: expected speed_factor to be a scalar or in the form [x, y, h])&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">speed_factor</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sf</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">speed_factor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">speed_factor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">speed_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">speed_factor</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Speed_factor: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_factor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_factor</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_factor</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(using smaller timestep: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="si">}</span><span class="s2"> s)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_list</span><span class="p">:</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">velmax_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_factor</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">velmax_pos</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">velmax_neg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_factor</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">velmax_neg</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">D_pos</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">D_pos</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_factor</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">D_neg</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">D_neg</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_factor</span>

        <span class="c1"># Spiraling</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">SPIRAL</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">npl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Can&#39;t perform a spiral of zero initial radius! Sorry.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Terminated.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">set_aborted</span><span class="p">(</span><span class="n">MoveResult</span><span class="p">(</span><span class="s2">&quot;degen&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">spr_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spiral_move</span><span class="p">(</span>
                <span class="n">c</span><span class="o">=</span><span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                <span class="n">N</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">direc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">mpr</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">x_seq_spr</span><span class="p">,</span> <span class="n">T_spr</span><span class="p">,</span> <span class="n">spr_success</span> <span class="o">=</span> <span class="n">spr_results</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_seq_spr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">spr_success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x_seq</span> <span class="o">=</span> <span class="n">x_seq_spr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_goal</span><span class="p">(</span><span class="n">x_seq_spr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_seq_spr</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_seq_spr</span><span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">fill_value</span><span class="o">=</span><span class="n">x_seq_spr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="n">T_spr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lock_tree</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desired spiral path is blocked!&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Terminated.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">set_aborted</span><span class="p">(</span><span class="n">MoveResult</span><span class="p">(</span><span class="s2">&quot;blocked&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Standard driving</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">MoveGoal</span><span class="o">.</span><span class="n">DRIVE</span><span class="p">,</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">DRIVE_SMOOTH</span><span class="p">]:</span>

            <span class="c1"># Find the heading that points to the goal</span>
            <span class="n">p_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">h_goal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">p_err</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p_err</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># If we aren&#39;t within a cone of that heading and the goal is far away, construct rotation</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_diff</span><span class="p">(</span><span class="n">h_goal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">pointshoot_tol</span>
                <span class="ow">and</span> <span class="n">npl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p_err</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">free_radius</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">!=</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">DRIVE_SMOOTH</span>
            <span class="p">):</span>
                <span class="n">x_seq_rot</span><span class="p">,</span> <span class="n">T_rot</span><span class="p">,</span> <span class="n">rot_success</span><span class="p">,</span> <span class="n">u_seq_rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_move</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">h_goal</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">pointshoot_tol</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Rotating towards goal (duration: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">T_rot</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rot_success</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(cannot rotate completely!)&quot;</span><span class="p">)</span>

                <span class="c1"># Begin interpolating rotation move</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_seq_rot</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_seq_rot</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_seq_rot</span><span class="p">),</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">fill_value</span><span class="o">=</span><span class="n">x_seq_rot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:],</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_eff</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u_seq_rot</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u_seq_rot</span><span class="p">),</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">fill_value</span><span class="o">=</span><span class="n">u_seq_rot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:],</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                        <span class="n">T_rot</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">basic_duration</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">params</span><span class="o">.</span><span class="n">velmax_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_seq_rot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">basic_duration</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">basic_duration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">DRIVE_SMOOTH</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">=</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">DRIVE</span>

        <span class="c1"># Translate or look-at move</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">SKID</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">basic_duration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

        <span class="c1"># (debug)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_tree</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Begin tree-chaining loop</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
            <span class="n">clean_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_chain</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Print feedback</span>
            <span class="k">if</span> <span class="n">clean_update</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preempted</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">unreachable</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stuck</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_tree</span>
            <span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Move </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">move_count</span><span class="si">}</span><span class="se">\n</span><span class="s2">----&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Behavior: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">enroute_behavior</span><span class="o">.</span><span class="vm">__name__</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Reached goal region: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">enroute_behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">plan_reached_goal</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Goal bias: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal_bias</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tree size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Move duration: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># elif not self.lock_tree:</span>
            <span class="c1">#     print(&quot;\nIssue Status\n----&quot;)</span>
            <span class="c1">#     print(&quot;Stuck: {}&quot;.format(self.stuck))</span>
            <span class="c1">#     print(&quot;Collided: {}&quot;.format(self.collided))</span>
            <span class="c1">#     print(&quot;Unreachable: {}&quot;.format(self.unreachable))</span>
            <span class="c1">#     print(&quot;Preempted: {}&quot;.format(self.preempted))</span>
            <span class="c1">#     print(&quot;Tree size: {}&quot;.format(self.tree.size))</span>
            <span class="c1">#     print(&quot;Move duration: {}&quot;.format(np.round(self.next_runtime, 1)))</span>

            <span class="c1"># Check if action goal is complete</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">SPIRAL</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publish_path</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_till_issue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unreachable</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="s2">&quot;blocked&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">T_spr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">params</span><span class="o">.</span><span class="n">real_tol</span><span class="p">):</span>
                <span class="n">remain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">remain</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_eff</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">set_succeeded</span><span class="p">(</span><span class="n">MoveResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># Check for abrupt termination or unreachability</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preempted</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">unreachable</span><span class="p">:</span>
                <span class="n">remain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">))))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">remain</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_eff</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Terminated.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">set_aborted</span><span class="p">(</span><span class="n">MoveResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1"># WHERE IT HAPPENS</span>
<div class="viewcode-block" id="LQRRT_Node.tree_chain"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.tree_chain">[docs]</a>    <span class="k">def</span> <span class="nf">tree_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plans an lqRRT and sets things up to chain along another lqRRT when</span>
<span class="sd">        called again.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure we are not currently in an update or a collided state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_tree</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Thread locking, lol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_tree</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># No issue</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_till_issue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">basic_duration</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stuck</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">basic_duration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stuck</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_behavior</span><span class="p">()</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">goal_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">guide</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pruning</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_exploration</span><span class="p">()</span>

        <span class="c1"># Distant issue</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_till_issue</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">basic_duration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">basic_duration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_behavior</span><span class="p">()</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">goal_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">guide</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pruning</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_exploration</span><span class="p">()</span>

        <span class="c1"># Immediate issue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span>
            <span class="n">remain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">remain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_eff</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">basic_duration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span> <span class="o">=</span> <span class="n">remain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_behavior</span><span class="p">()</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">goal_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">guide</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pruning</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_exploration</span><span class="p">()</span>

        <span class="c1"># Special first-move case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_plan_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_plan_time</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_plan_time</span>

        <span class="c1"># (debug)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stuck</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_till_issue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="ow">is</span> <span class="kc">None</span>

        <span class="c1"># Update plan</span>
        <span class="n">clean_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">update_plan</span><span class="p">(</span>
            <span class="n">x0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">,</span>
            <span class="n">sample_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">,</span>
            <span class="n">goal_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal_bias</span><span class="p">,</span>
            <span class="n">guide</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">guide</span><span class="p">,</span>
            <span class="n">pruning</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pruning</span><span class="p">,</span>
            <span class="n">specific_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update finished properly</span>
        <span class="k">if</span> <span class="n">clean_update</span><span class="p">:</span>
            <span class="c1"># We might be stuck if tree is oddly small</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Increase stuck count towards threshold</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stuck_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stuck_count</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">stuck_threshold</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">fail_threshold</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Not making any progress.</span><span class="se">\n</span><span class="s2">Goal may be unreachable.&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unreachable</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="s2">&quot;unreachable&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">I think we&#39;re stuck...&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stuck</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stuck_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stuck</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stuck</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stuck_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Cash-in new goods</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">x_seq</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">u_seq</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">tree</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">get_state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">get_effort</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">basic_duration</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span> <span class="o">*=</span> <span class="n">params</span><span class="o">.</span><span class="n">fudge_factor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enroute_behavior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_till_issue</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Visualizers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publish_tree</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publish_path</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publish_expl</span><span class="p">()</span>

        <span class="c1"># Make sure all planners are actually unkilled</span>
        <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_list</span><span class="p">:</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">unkill</span><span class="p">()</span>

        <span class="c1"># Unlocking, lol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_tree</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">clean_update</span></div>

    <span class="c1"># DECISIONS</span>
<div class="viewcode-block" id="LQRRT_Node.select_behavior"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.select_behavior">[docs]</a>    <span class="k">def</span> <span class="nf">select_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModuleType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Chooses the behavior for the current move, and returns</span>
<span class="sd">        the associated module containing the implementation of</span>
<span class="sd">        that behavior.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ModuleType: A module with the behavior implementation</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: No relevant implementation could be found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Are we stuck?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stuck</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">escape</span>

        <span class="c1"># Positional error norm of next_seed</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">npl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Are we driving?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">DRIVE</span><span class="p">:</span>
            <span class="c1"># All clear?</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">free_radius</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">boat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">car</span>

        <span class="c1"># Are we skidding?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">SKID</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">boat</span>

        <span class="c1"># (debug)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Indeterminant behavior configuration.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LQRRT_Node.select_exploration"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.select_exploration">[docs]</a>    <span class="k">def</span> <span class="nf">select_exploration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Chooses the goal bias, sample space, guide point, and pruning</span>
<span class="sd">        choice for the current move and behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Escaping means maximal exploration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="ow">is</span> <span class="n">escape</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">guide</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">npl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">free_radius</span><span class="p">:</span>
                    <span class="n">gs</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">free_radius</span> <span class="o">*</span> <span class="p">(</span><span class="n">vec</span> <span class="o">/</span> <span class="n">dist</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guide</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">escape</span><span class="o">.</span><span class="n">gen_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">),</span> <span class="n">gs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Analyze ogrid to find good bias and sample space buffer</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">blind</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Get opencv-ready image from current ogrid (255 is occupied, 0 is clear)</span>
            <span class="n">occ_img</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ogrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
            <span class="p">)</span>

            <span class="c1"># Dilate the image</span>
            <span class="n">boat_pix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ogrid_cpm</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">boat_width</span><span class="p">)</span>
            <span class="n">boat_pix</span> <span class="o">+=</span> <span class="n">boat_pix</span> <span class="o">%</span> <span class="mi">2</span>
            <span class="n">occ_img_dial</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">occ_img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">boat_pix</span><span class="p">,</span> <span class="n">boat_pix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>

            <span class="c1"># Construct the initial sample space and get bounds in pixel coordinates</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">gen_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
            <span class="n">pmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intup</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_cpm</span> <span class="o">*</span> <span class="p">([</span><span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ss</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_origin</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">pmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intup</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_cpm</span> <span class="o">*</span> <span class="p">([</span><span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ss</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_origin</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Other quantities in pixel coordinates</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ogrid_cpm</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_origin</span><span class="p">))</span>
            <span class="n">goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ogrid_cpm</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_origin</span><span class="p">))</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ogrid_cpm</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">ss_step</span><span class="p">)</span>

            <span class="c1"># Make sure seed and goal are physically meaningful</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">occ_img_dial</span><span class="p">[</span><span class="n">seed</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">seed</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">occ_img_dial</span><span class="p">[</span><span class="n">goal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">goal</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Goal and/or seed out of bounds of occupancy grid!&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">escape</span><span class="o">.</span><span class="n">gen_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">),</span>
                    <span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Initializations</span>
            <span class="n">found_entry</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">push</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">npush</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
            <span class="n">last_offsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">pmin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">ss_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">occ_img_dial</span><span class="p">[</span><span class="n">pmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">pmax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">pmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">ss_goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intup</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">goal</span><span class="p">,</span> <span class="n">last_offsets</span><span class="p">))</span>
            <span class="n">ss_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intup</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">last_offsets</span><span class="p">))</span>

            <span class="c1"># Iteratively determine how much to push out the sample space</span>
            <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span><span class="n">push</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">occ_img_dial</span><span class="p">))):</span>
                <span class="k">if</span> <span class="n">found_entry</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># Find dividing boundary points</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">ss_img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Occupancy grid analysis failed... Please report this!&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span>
                        <span class="mf">0.5</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">gen_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">),</span>
                        <span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">bpts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_analysis</span><span class="p">(</span><span class="n">ss_img</span><span class="p">,</span> <span class="n">ss_seed</span><span class="p">,</span> <span class="n">ss_goal</span><span class="p">)</span>

                <span class="c1"># If already connected, no expansion necessary</span>
                <span class="k">if</span> <span class="n">bpts</span> <span class="o">==</span> <span class="s2">&quot;connected&quot;</span><span class="p">:</span>
                    <span class="n">found_entry</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

                <span class="c1"># If impossible to connect, no sense in expanding</span>
                <span class="k">if</span> <span class="n">bpts</span> <span class="o">==</span> <span class="s2">&quot;isolated&quot;</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># Otherwise, prepare to push ss based on boundary intercepts</span>
                <span class="n">push_xmin</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">push_xmax</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">push_ymin</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">push_ymax</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Buffered boundary imensions</span>
                <span class="n">row_min</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">col_min</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">row_max</span> <span class="o">=</span> <span class="n">ss_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
                <span class="n">col_max</span> <span class="o">=</span> <span class="n">ss_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>

                <span class="c1"># Classify boundary points</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="n">bpts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="n">col_min</span><span class="p">:</span>  <span class="c1"># left</span>
                        <span class="n">push_xmin</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">row_min</span><span class="p">:</span>  <span class="c1"># top left</span>
                            <span class="n">push_ymin</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">row</span> <span class="o">==</span> <span class="n">row_max</span><span class="p">:</span>  <span class="c1"># bottom left</span>
                            <span class="n">push_ymax</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="n">col_max</span><span class="p">:</span>  <span class="c1"># right</span>
                        <span class="n">push_xmax</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">row_min</span><span class="p">:</span>  <span class="c1"># top right</span>
                            <span class="n">push_ymin</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">row</span> <span class="o">==</span> <span class="n">row_max</span><span class="p">:</span>  <span class="c1"># bottom left</span>
                            <span class="n">push_ymax</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">row</span> <span class="o">==</span> <span class="n">row_min</span><span class="p">:</span>  <span class="c1"># top</span>
                        <span class="n">push_ymin</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">row</span> <span class="o">==</span> <span class="n">row_max</span><span class="p">:</span>  <span class="c1"># bottom</span>
                        <span class="n">push_ymax</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Push accordingly</span>
                    <span class="k">if</span> <span class="n">push_xmin</span><span class="p">:</span>
                        <span class="n">push</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">step</span>
                        <span class="n">npush</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">push_xmax</span><span class="p">:</span>
                        <span class="n">push</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">step</span>
                        <span class="n">npush</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">push_ymin</span><span class="p">:</span>
                        <span class="n">push</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">step</span>
                        <span class="n">npush</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">push_ymax</span><span class="p">:</span>
                        <span class="n">push</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">step</span>
                        <span class="n">npush</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Get image cropped to sample space and offset points of interest</span>
                    <span class="n">offset_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">push</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">push</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">offset_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">push</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">push</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">ss_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                        <span class="n">occ_img_dial</span><span class="p">[</span>
                            <span class="n">offset_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">offset_y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">offset_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">offset_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">ss_img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Occupancy grid analysis failed... Please report this!&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">(</span>
                            <span class="mf">0.5</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">gen_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">),</span>
                            <span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">ss_goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intup</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">goal</span><span class="p">,</span> <span class="p">[</span><span class="n">offset_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offset_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
                    <span class="n">ss_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intup</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="p">[</span><span class="n">offset_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offset_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
                    <span class="n">test_flood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ss_img</span><span class="p">)</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">floodFill</span><span class="p">(</span>
                        <span class="n">test_flood</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">test_flood</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">test_flood</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                        <span class="p">),</span>
                        <span class="n">ss_goal</span><span class="p">,</span>
                        <span class="mi">69</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">test_flood</span><span class="p">[</span><span class="n">ss_seed</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ss_seed</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">69</span><span class="p">:</span>
                        <span class="n">gs</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">],</span> <span class="p">[</span><span class="n">last_offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">last_offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_cpm</span>
                        <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_origin</span>
                        <span class="n">found_entry</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                <span class="c1"># Used for remembering the previous sample space coordinates</span>
                <span class="n">last_offsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">offset_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offset_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="c1"># If we expanded to the limit and found no entry (and goal is unoccupied), goal is infeasible</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_entry</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Goal is unreachable!&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unreachable</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="s2">&quot;unreachable&quot;</span>
                <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_list</span><span class="p">:</span>
                    <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">kill_update</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">escape</span><span class="o">.</span><span class="n">gen_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">),</span>
                    <span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Apply push in real coordinates</span>
            <span class="n">push</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">push</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_cpm</span>
            <span class="k">if</span> <span class="n">npush</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">push</span> <span class="o">+=</span> <span class="n">params</span><span class="o">.</span><span class="n">boat_length</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">gen_ss</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="n">push</span> <span class="o">+</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">ss_start</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
            <span class="p">)</span>

            <span class="c1"># Select bias based on density of ogrid in sample space</span>
            <span class="k">if</span> <span class="n">ss_img</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">free_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ss_img</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">ss_img</span><span class="o">.</span><span class="n">size</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">free_ratio</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">npush</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mf">0.9</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">-=</span> <span class="mf">0.2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">gen_ss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>

        <span class="c1"># For boating</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="ow">is</span> <span class="n">boat</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">npl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_seed</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">free_radius</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ss</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">boat</span><span class="o">.</span><span class="n">focus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">([</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ss</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">([</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ss</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># For car-ing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="ow">is</span> <span class="n">car</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">([</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ss</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># (debug)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Indeterminant behavior configuration.&quot;</span><span class="p">)</span></div>

    <span class="c1"># VERIFICATIONS</span>
<div class="viewcode-block" id="LQRRT_Node.is_feasible"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.is_feasible">[docs]</a>    <span class="k">def</span> <span class="nf">is_feasible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">u</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a state x and effort u, returns whether (x, u) is feasible.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (np.ndarray): The state to verify the feasibility of</span>
<span class="sd">            u (np.ndarray): The corresponding effort to verify the feasibility of</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the state is feasible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If there&#39;s no ogrid yet or it&#39;s a blind move, anywhere is valid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">blind</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Body to world</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]])</span>

        <span class="c1"># Vehicle points in world frame</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">vps</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Check for collision</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ogrid_cpm</span> <span class="o">*</span> <span class="p">(</span><span class="n">points</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_origin</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">grid_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[</span><span class="n">indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Greater than threshold is a hit</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">grid_values</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_threshold</span><span class="p">)</span></div>

<div class="viewcode-block" id="LQRRT_Node.reevaluate_plan"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.reevaluate_plan">[docs]</a>    <span class="k">def</span> <span class="nf">reevaluate_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterates through the current plan re-checking for feasibility using</span>
<span class="sd">          the newest ogrid data, looking for a clear path if we are escaping,</span>
<span class="sd">          and checking that the goal is still feasible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure a plan exists and that we aren&#39;t currently fixing it</span>
        <span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span>
        <span class="n">x_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_seq</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">last_update_time</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x_seq</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_till_issue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Timesteps since last update</span>
        <span class="n">iters_passed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_update_time</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Make sure that the goal pose is still feasible</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">!=</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">SPIRAL</span>
        <span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The given goal is occupied!</span><span class="se">\n</span><span class="s2">Going nearby instead.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_till_issue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="s2">&quot;occupied&quot;</span>
            <span class="n">p_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">p_err_mag</span> <span class="o">=</span> <span class="n">npl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p_err</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_err_mag</span> <span class="o">&lt;=</span> <span class="n">npl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">real_tol</span><span class="p">[:</span><span class="mi">2</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;...looks like I am already nearby.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_goal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">npoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_err_mag</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">boat_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">xline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">npoints</span><span class="p">)</span>
            <span class="n">yline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npoints</span><span class="p">)</span>
            <span class="n">hline</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">p_err</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p_err</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">*</span> <span class="n">npoints</span>
            <span class="n">sline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xline</span><span class="p">,</span> <span class="n">yline</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">npoints</span><span class="p">))))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">found_free_goal</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sline</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_goal</span><span class="p">(</span><span class="n">sline</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">found_free_goal</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_free_goal</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Could not find a reasonable free goal!&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unreachable</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="s2">&quot;unreachable&quot;</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">boat</span><span class="o">.</span><span class="n">focus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">SKID</span><span class="p">:</span>
                <span class="n">focus_vec</span> <span class="o">=</span> <span class="n">boat</span><span class="o">.</span><span class="n">focus</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">focus_goal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
                <span class="n">focus_goal</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">focus_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">focus_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">(</span><span class="n">focus_goal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_goal</span><span class="p">(</span><span class="n">focus_goal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cancelling focus.&quot;</span><span class="p">)</span>
                    <span class="n">boat</span><span class="o">.</span><span class="n">focus</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_list</span><span class="p">:</span>
                <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">kill_update</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Check that the next reeval_time seconds in the current plan are still feasible</span>
        <span class="n">p_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
            <span class="n">x_seq</span><span class="p">[</span>
                <span class="n">iters_passed</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">x_seq</span><span class="p">),</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">iters_passed</span> <span class="o">+</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">reeval_time</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)),</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">reeval_limit</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_seq</span><span class="p">):</span>
            <span class="n">p_seq</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">p_seq</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_seq</span><span class="p">))):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
                    <span class="n">time_till_collision</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
                    <span class="k">if</span> <span class="n">time_till_collision</span> <span class="o">&lt;=</span> <span class="n">params</span><span class="o">.</span><span class="n">collision_threshold</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collided</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Collided! (*seppuku*)&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;But we cannot throw away our shot!&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">collided</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="s2">&quot;collided&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found collision on current path!</span><span class="se">\n</span><span class="s2">Time till collision: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">time_till_collision</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">time_till_issue</span> <span class="o">=</span> <span class="n">time_till_collision</span>
                        <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_list</span><span class="p">:</span>
                            <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">kill_update</span><span class="p">()</span>
                    <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collided</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No longer collided! (*unseppuku*)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collided</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">==</span> <span class="s2">&quot;collided&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># If we are escaping, check if we have a clear path again</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enroute_behavior</span> <span class="ow">is</span> <span class="n">escape</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_update_time</span><span class="p">)</span>
            <span class="n">p_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">npl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p_err</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">free_radius</span><span class="p">:</span>
                <span class="n">npoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p_err</span><span class="p">)</span> <span class="o">/</span> <span class="n">params</span><span class="o">.</span><span class="n">vps_spacing</span><span class="p">)</span>
                <span class="n">xline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">npoints</span><span class="p">)</span>
                <span class="n">yline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npoints</span><span class="p">)</span>
                <span class="n">hline</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">p_err</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p_err</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">*</span> <span class="n">npoints</span>
                <span class="n">sline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xline</span><span class="p">,</span> <span class="n">yline</span><span class="p">,</span> <span class="n">hline</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">npoints</span><span class="p">))))</span><span class="o">.</span><span class="n">T</span>
                <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sline</span><span class="p">:</span>
                    <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">checks</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time_till_issue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">=</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">DRIVE</span>
                    <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_list</span><span class="p">:</span>
                        <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">kill_update</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stuck</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stuck_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Clear path found!&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

        <span class="c1"># No concerns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_till_issue</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LQRRT_Node.action_check"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.action_check">[docs]</a>    <span class="k">def</span> <span class="nf">action_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">rospy</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">TimerEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manages action preempting. Serves as the callback to a Timer operating</span>
<span class="sd">          opereating every self.revisit_period seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preempted</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">is_preempt_requested</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_tree</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preempted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="s2">&quot;preempted&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Action preempted!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_list</span><span class="p">:</span>
                    <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">kill_update</span><span class="p">()</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">next_runtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_runtime</span>
        <span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span>
        <span class="k">if</span> <span class="n">next_runtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">last_update_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_till_next_branch</span> <span class="o">=</span> <span class="n">next_runtime</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_update_time</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_type</span> <span class="o">==</span> <span class="n">MoveGoal</span><span class="o">.</span><span class="n">SPIRAL</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">publish_feedback</span><span class="p">(</span>
                    <span class="n">MoveFeedback</span><span class="p">(</span>
                        <span class="s2">&quot;boat&quot;</span><span class="p">,</span>
                        <span class="mi">0</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_update_time</span><span class="p">)</span>
                        <span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
                        <span class="n">time_till_next_branch</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enroute_behavior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_server</span><span class="o">.</span><span class="n">publish_feedback</span><span class="p">(</span>
                    <span class="n">MoveFeedback</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">enroute_behavior</span><span class="o">.</span><span class="vm">__name__</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_update_time</span><span class="p">)</span>
                        <span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
                        <span class="n">time_till_next_branch</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></div>

    <span class="c1"># LIL MATH DOERS</span>
<div class="viewcode-block" id="LQRRT_Node.rotation_move"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.rotation_move">[docs]</a>    <span class="k">def</span> <span class="nf">rotation_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">h</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a state sequence, total time, success bool and effort</span>
<span class="sd">        sequence for a simple rotate in place move. Success is False if</span>
<span class="sd">        the move becomes infeasible before the state heading x[2] is within</span>
<span class="sd">        the goal heading h+-tol. Give x (start state), and h (goal heading).</span>

<span class="sd">        Args:</span>
<span class="sd">            x (List[float]): The current state</span>
<span class="sd">            h (float): The desired heading (similar to x[2])</span>
<span class="sd">            tol (float): The tolerance of the heading</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[np.ndarray, float, bool, np.ndarray]: A tuple containing</span>
<span class="sd">              the new state array, the amount of time the movement will take,</span>
<span class="sd">              whether the operation is feasible, and the new effort array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set-up</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">xg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">xg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="n">x_seq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">u_seq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Simulate rotation move</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>

            <span class="c1"># Stop if pose is infeasible</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">))),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_seq</span><span class="p">):</span>
                <span class="n">portion</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">FPR</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_seq</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">x_seq</span><span class="p">[:</span> <span class="nb">int</span><span class="p">(</span><span class="n">portion</span><span class="p">)],</span>
                    <span class="n">T</span> <span class="o">-</span> <span class="n">portion</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="n">u_seq</span><span class="p">[:</span> <span class="nb">int</span><span class="p">(</span><span class="n">portion</span><span class="p">)],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">u_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

            <span class="c1"># Keep rotating towards goal until tolerance is met</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">xg</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">x_seq</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">u_seq</span><span class="p">)</span>

            <span class="c1"># Step</span>
            <span class="n">u</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">boat</span><span class="o">.</span><span class="n">lqr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">boat</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="LQRRT_Node.spiral_move"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.spiral_move">[docs]</a>    <span class="k">def</span> <span class="nf">spiral_move</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">c</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">direc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mpr</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a movement pattern for a spiral movement.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (List[float]): Initial state vector.</span>
<span class="sd">            c (List[float]): Coordinates of initial point.</span>
<span class="sd">            N (int): The number of revolutions to make.</span>
<span class="sd">            direc (int): Whether to move + or - in regards to the z-axis</span>
<span class="sd">            mpr (float): The meters expansion of the spiral per radian</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[np.ndarray, float, bool]: The state sequence of the spiral</span>
<span class="sd">              movement, the amount of time (in seconds) required to make the</span>
<span class="sd">              movement, and whether the movement is feasible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set-up</span>
        <span class="k">if</span> <span class="n">direc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mpr</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">vt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x_seq</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Radial vector</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span>
        <span class="n">rmag</span> <span class="o">=</span> <span class="n">npl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">rdir</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rmag</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">rmag</span><span class="p">)</span>

        <span class="c1"># Tangential velocity and acceleration</span>
        <span class="k">if</span> <span class="n">direc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">rdir</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">rdir</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">rdir</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rdir</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">h0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_diff</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ht</span><span class="p">)</span>
        <span class="n">R_h0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">h0</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">h0</span><span class="p">)],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">h0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">h0</span><span class="p">)]])</span>
        <span class="n">vtmax</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">R_h0</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_factor</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">velmax_pos</span><span class="p">[:</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">atmax</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">R_h0</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="n">params</span><span class="o">.</span><span class="n">Fx_max</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">Fy_max</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">params</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="n">magic_ratio</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="mi">5</span>

        <span class="c1"># Simulate spiral move</span>
        <span class="n">anglim</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">anglim</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>

            <span class="c1"># Rotation for this instant</span>
            <span class="n">radfactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">magic_ratio</span> <span class="o">*</span> <span class="n">rmag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">vt</span> <span class="o">+</span> <span class="n">radfactor</span> <span class="o">*</span> <span class="n">atmax</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radfactor</span> <span class="o">*</span> <span class="n">vtmax</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">direc</span> <span class="o">*</span> <span class="n">vt</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rmag</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">rmag</span><span class="p">)</span>
            <span class="n">dang</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dang</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dang</span><span class="p">)],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dang</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dang</span><span class="p">)]])</span>

            <span class="c1"># Update</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">ang</span> <span class="o">+=</span> <span class="n">dang</span>
            <span class="n">rdir</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rdir</span><span class="p">)</span>
            <span class="n">rmag</span> <span class="o">+=</span> <span class="n">mpr</span> <span class="o">*</span> <span class="n">dang</span>

            <span class="c1"># Record</span>
            <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">rmag</span> <span class="o">*</span> <span class="n">rdir</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">dang</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">R_h0</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="n">vt</span><span class="p">,</span> <span class="n">mpr</span> <span class="o">*</span> <span class="n">w</span><span class="p">])</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
                <span class="n">x_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x_seq</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">x_seq</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="LQRRT_Node.erf"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.erf">[docs]</a>    <span class="k">def</span> <span class="nf">erf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_state</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">state</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns error given two states goal_state and state.</span>
<span class="sd">        Angle differences are taken properly on SO2.</span>

<span class="sd">        Args:</span>
<span class="sd">            goal_state (List[float]): The goal state</span>
<span class="sd">            state (List[float]): The state to derive the error from</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The error between the goal and passed state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">goal_state</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_diff</span><span class="p">(</span><span class="n">goal_state</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">e</span></div>

<div class="viewcode-block" id="LQRRT_Node.angle_diff"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.angle_diff">[docs]</a>    <span class="k">def</span> <span class="nf">angle_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle_goal</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes an angle difference properly on SO2.</span>

<span class="sd">        Args:</span>
<span class="sd">            angle_goal (float): The goal angle.</span>
<span class="sd">            angle (float): The angle to grab the difference from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The difference between the desired and goal angle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_goal</span><span class="p">)</span>
        <span class="n">sg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle_goal</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">sg</span> <span class="o">*</span> <span class="n">c</span> <span class="o">-</span> <span class="n">cg</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">cg</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">sg</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span></div>

<div class="viewcode-block" id="LQRRT_Node.boundary_analysis"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.boundary_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">boundary_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">goal</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of the two boundary points of the contour dividing seed from</span>
<span class="sd">        goal in the occupancy image img. If the seed and goal are connected, returns</span>
<span class="sd">        &#39;connected&#39; or if they are terminally isolated, returns &#39;isolated&#39;. Make sure</span>
<span class="sd">        seed and goal are intups and in the same pixel coordinates as img, and that</span>
<span class="sd">        occupied pixels have value 255 in img.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set-up</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">fc1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">fc2</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">bpts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If goal can flood to seed then done</span>
        <span class="n">flood_goal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">floodFill</span><span class="p">(</span>
            <span class="n">flood_goal</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">flood_goal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">flood_goal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
            <span class="n">goal</span><span class="p">,</span>
            <span class="n">fc1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">flood_goal</span><span class="p">[</span><span class="n">seed</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">seed</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="n">fc1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;connected&quot;</span>

        <span class="c1"># Filter out the dividing boundary</span>
        <span class="n">flood_goal_thresh</span> <span class="o">=</span> <span class="n">fc1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">flood_goal</span><span class="p">,</span> <span class="n">fc1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">flood_seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">flood_goal_thresh</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">floodFill</span><span class="p">(</span>
            <span class="n">flood_seed</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">flood_seed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">flood_seed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
            <span class="n">seed</span><span class="p">,</span>
            <span class="n">fc2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">flood_seed_thresh</span> <span class="o">=</span> <span class="n">fc2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">flood_seed</span><span class="p">,</span> <span class="n">fc2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Buffered boundaries and dimensions</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">row_min</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">col_min</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">row_max</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">col_max</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>

        <span class="c1"># Buffered boundary points that were occupied, in boundary coordinates</span>
        <span class="n">left_cands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="n">right_cands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="n">top_cands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="n">bottom_cands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

        <span class="c1"># Convert to original coordinates</span>
        <span class="n">left_cands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">left_cands</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col_min</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">left_cands</span><span class="p">)))</span>
        <span class="n">right_cands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">right_cands</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col_max</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">right_cands</span><span class="p">)))</span>
        <span class="n">top_cands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">row_min</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">top_cands</span><span class="p">),</span> <span class="n">top_cands</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">bottom_cands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">(</span><span class="n">row_max</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">bottom_cands</span><span class="p">),</span> <span class="n">bottom_cands</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">cands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">left_cands</span><span class="p">,</span> <span class="n">right_cands</span><span class="p">,</span> <span class="n">top_cands</span><span class="p">,</span> <span class="n">bottom_cands</span><span class="p">))</span>

        <span class="c1"># Iterate through candidates and store the dividing boundary points</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cands</span><span class="p">:</span>
            <span class="n">hood</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hood</span><span class="p">(</span><span class="n">flood_seed_thresh</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">hood</span> <span class="o">==</span> <span class="n">fc2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">hood</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">bpts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span>

        <span class="c1"># If they are not connected but there are no boundary points,</span>
        <span class="c1"># they are forever isolated</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bpts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;isolated&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bpts</span></div>

    <span class="c1"># PUBDUBS</span>
<div class="viewcode-block" id="LQRRT_Node.set_goal"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.set_goal">[docs]</a>    <span class="k">def</span> <span class="nf">set_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publishes the goal state to the goal publisher.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create and establish goal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_list</span><span class="p">:</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">set_goal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>

        <span class="c1"># Publish goal to the goal publisher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pack_posestamped</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">),</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LQRRT_Node.publish_ref"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.publish_ref">[docs]</a>    <span class="k">def</span> <span class="nf">publish_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publishes the reference trajectory as an Odometry message to the ref</span>
<span class="sd">        publisher. Also publishes the reference effort as a WrenchStamped</span>
<span class="sd">        message to the effort publisher.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure a plan exists</span>
        <span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">last_update_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Time since last update</span>
        <span class="n">time_since</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_update_time</span>
        <span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="c1"># Publish interpolated reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pack_odom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="n">time_since</span><span class="p">),</span> <span class="n">stamp</span><span class="p">))</span>

        <span class="c1"># Not really necessary, but for fun-and-profit also publish the planner&#39;s effort wrench</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eff_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pack_wrenchstamped</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_eff</span><span class="p">(</span><span class="n">time_since</span><span class="p">),</span> <span class="n">stamp</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="LQRRT_Node.publish_path"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.publish_path">[docs]</a>    <span class="k">def</span> <span class="nf">publish_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publishes all tree-node poses along the current path as a PoseArray.</span>
<span class="sd">        Publishes to the class&#39; path publisher.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure a plan exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Construct pose array and publish</span>
        <span class="n">pose_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_seq</span><span class="p">:</span>
            <span class="n">pose_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pack_pose</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pose_list</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">PoseArray</span><span class="p">(</span><span class="n">poses</span><span class="o">=</span><span class="n">pose_list</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_frame_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="LQRRT_Node.publish_tree"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.publish_tree">[docs]</a>    <span class="k">def</span> <span class="nf">publish_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publishes all tree-node poses as a PoseArray. Publishes to the class&#39;</span>
<span class="sd">        tree publisher.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure a plan exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Construct pose array and publish</span>
        <span class="n">pose_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
            <span class="n">pose_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pack_pose</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pose_list</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">PoseArray</span><span class="p">(</span><span class="n">poses</span><span class="o">=</span><span class="n">pose_list</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_frame_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="LQRRT_Node.publish_expl"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.publish_expl">[docs]</a>    <span class="k">def</span> <span class="nf">publish_expl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publishes sample space as a PolygonStamped to the sample space</span>
<span class="sd">        publisher and publishes the guide point as a PointStamped to the guide</span>
<span class="sd">        publisher.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure a plan exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">guide</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Construct and publish</span>
        <span class="n">point_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Point32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">Point32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">Point32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">Point32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_space</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">ss_msg</span> <span class="o">=</span> <span class="n">PolygonStamped</span><span class="p">()</span>
        <span class="n">ss_msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_frame_id</span>
        <span class="n">ss_msg</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">point_list</span>

        <span class="c1"># Publish to publishers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampspace_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">ss_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guide_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pack_pointstamped</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guide</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span></div>

    <span class="c1"># SUBSCRUBS</span>
<div class="viewcode-block" id="LQRRT_Node.ogrid_cb"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.ogrid_cb">[docs]</a>    <span class="k">def</span> <span class="nf">ogrid_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">OccupancyGrid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Acts as the callback function to a subscriber to the odom topic.</span>
<span class="sd">        Expects an OccupancyGrid message. Stores the ogrid array and origin</span>
<span class="sd">        vector, and then reevaluates the path plan.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (OccupancyGrid): The message passed by the callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store relevant values</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ogrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ogrid_cpm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">resolution</span>

        <span class="c1"># Reevaluate plan based on occupancy grid</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reevaluate_plan</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(WARNING: something went wrong in reevaluate_plan)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check for plan reevaluation taking a long time</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(WARNING: ogrid callback is taking </span><span class="si">{}</span><span class="s2"> seconds)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="LQRRT_Node.odom_cb"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.odom_cb">[docs]</a>    <span class="k">def</span> <span class="nf">odom_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Odometry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback to the odometry topic subscriber. Stores the current state of</span>
<span class="sd">        the tracking vehicle and its reference frame. Sets the class tracking</span>
<span class="sd">        variable to True or False based on if the vehicle is successfully</span>
<span class="sd">        tracking.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (Odometry): The Odometry message received by the callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store relevant values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world_frame_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body_frame_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">child_frame_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack_odom</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span>

        <span class="c1"># Calculate error between the goal and state and tell if tracking is successful</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">last_update_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rostime</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_update_time</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">real_tol</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="c1"># CONVERTERS</span>
<div class="viewcode-block" id="LQRRT_Node.unpack_pose"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.unpack_pose">[docs]</a>    <span class="k">def</span> <span class="nf">unpack_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Pose</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a Pose message into a state vector with zero velocity.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (Pose): The message to unpack.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: A state array containing the x-position, y-position,</span>
<span class="sd">              and yaw. The velocities are all zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">trns</span><span class="o">.</span><span class="n">euler_from_quaternion</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LQRRT_Node.unpack_odom"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.unpack_odom">[docs]</a>    <span class="k">def</span> <span class="nf">unpack_odom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Odometry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts an Odometry message into a state vector.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (Odometry): The Odometry message to unpack.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The new state vector, containing 6</span>
<span class="sd">              float values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">trns</span><span class="o">.</span><span class="n">euler_from_quaternion</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LQRRT_Node.pack_pose"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.pack_pose">[docs]</a>    <span class="k">def</span> <span class="nf">pack_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Pose</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the positional part of a state vector</span>
<span class="sd">        into a Pose message.</span>

<span class="sd">        For a timestamped message, use pack_posestamped.</span>

<span class="sd">        Args:</span>
<span class="sd">            state (List[float]): The current state of the robot. state[0]</span>
<span class="sd">              and state[1] represent x + y orientations. state[2]</span>
<span class="sd">              represents the orientation of the bot.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Pose: The Pose message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">state</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">quat</span> <span class="o">=</span> <span class="n">trns</span><span class="o">.</span><span class="n">quaternion_from_euler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">numpy_to_quaternion</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="LQRRT_Node.pack_posestamped"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.pack_posestamped">[docs]</a>    <span class="k">def</span> <span class="nf">pack_posestamped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">stamp</span><span class="p">:</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PoseStamped</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the positional part of a state vector into a PoseStamped</span>
<span class="sd">        message with a given header timestamp. For a non-stamped message, use</span>
<span class="sd">        pack_pose.</span>

<span class="sd">        Args:</span>
<span class="sd">            state (List[float]): The current state of the robot. state[0]</span>
<span class="sd">              and state[1] represent x + y orientations. state[2]</span>
<span class="sd">              represents the orientation of the bot.</span>
<span class="sd">            stamp (rospy.Time): The time that the bot&#39;s state existed as so.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PoseStamped: The PoseStamped message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">PoseStamped</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">stamp</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_frame_id</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">state</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">quat</span> <span class="o">=</span> <span class="n">trns</span><span class="o">.</span><span class="n">quaternion_from_euler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">numpy_to_quaternion</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="LQRRT_Node.pack_odom"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.pack_odom">[docs]</a>    <span class="k">def</span> <span class="nf">pack_odom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">stamp</span><span class="p">:</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Odometry</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a state vector into an Odometry message with</span>
<span class="sd">        given header timestamp.</span>

<span class="sd">        Args:</span>
<span class="sd">            state (List[float]): A list containing the following values:</span>
<span class="sd">              state[0] - The x-position of the bot</span>
<span class="sd">              state[1] - The y-position of the bot</span>
<span class="sd">              state[2] - The orientation (yaw) of the bot</span>
<span class="sd">              state[3] - The linear speed in the x-direction</span>
<span class="sd">              state[4] - The linear speed in the y-direction</span>
<span class="sd">              state[5] - The angular speed in the z-direction</span>
<span class="sd">            stamp (rospy.Time): The timestamp of the message.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Odometry: The packed Odometry message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">Odometry</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">stamp</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_frame_id</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">child_frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body_frame_id</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">state</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">quat</span> <span class="o">=</span> <span class="n">trns</span><span class="o">.</span><span class="n">quaternion_from_euler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">numpy_to_quaternion</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="LQRRT_Node.pack_pointstamped"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.pack_pointstamped">[docs]</a>    <span class="k">def</span> <span class="nf">pack_pointstamped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">stamp</span><span class="p">:</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PointStamped</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a point vector into a PointStamped message with a</span>
<span class="sd">        given header timestamp.</span>

<span class="sd">        Args:</span>
<span class="sd">            point (List[float]): The point vector. point[0] represents</span>
<span class="sd">              the x-component of the point and point[1] represents the</span>
<span class="sd">              y-component of the point.</span>
<span class="sd">            stamp (rospy.Time): The timestamp to attach to the message.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PointStamped: The message to pack the point as.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">PointStamped</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">stamp</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_frame_id</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">point</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="LQRRT_Node.pack_wrenchstamped"><a class="viewcode-back" href="../../../reference/pathplanning.html#navigator_path_planner.nodes.path_planner.LQRRT_Node.pack_wrenchstamped">[docs]</a>    <span class="k">def</span> <span class="nf">pack_wrenchstamped</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">effort</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">stamp</span><span class="p">:</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WrenchStamped</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts an effort vector into a WrenchStamped message</span>
<span class="sd">        with a given header timestamp.</span>

<span class="sd">        Args:</span>
<span class="sd">            effort (List[float]): The effort vector. effort[0] represents</span>
<span class="sd">              the x-component of force, effort[1] represents the y-component</span>
<span class="sd">              of force, and effort[2] represents the z-component of torque.</span>
<span class="sd">            stamp (rospy.Time): The timestamp to attach to the message.</span>

<span class="sd">        Returns:</span>
<span class="sd">            WrenchStamped: The message to pack the effort as.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">WrenchStamped</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">stamp</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body_frame_id</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">wrench</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">wrench</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">effort</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">wrench</span><span class="o">.</span><span class="n">torque</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">effort</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">msg</span></div></div>


<span class="c1"># Setup node</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s2">&quot;lqrrt_node&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">move_topic</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~move_topic&quot;</span><span class="p">,</span> <span class="s2">&quot;/move_to&quot;</span><span class="p">)</span>
    <span class="n">odom_topic</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~odom_topic&quot;</span><span class="p">,</span> <span class="s2">&quot;/odom&quot;</span><span class="p">)</span>
    <span class="n">ogrid_topic</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~ogrid_topic&quot;</span><span class="p">,</span> <span class="s2">&quot;/ogrid&quot;</span><span class="p">)</span>
    <span class="n">ogrid_threshold</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~ogrid_threshold&quot;</span><span class="p">,</span> <span class="s2">&quot;90&quot;</span><span class="p">)</span>
    <span class="n">ref_topic</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~ref_topic&quot;</span><span class="p">,</span> <span class="s2">&quot;/lqrrt/ref&quot;</span><span class="p">)</span>
    <span class="n">path_topic</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~path_topic&quot;</span><span class="p">,</span> <span class="s2">&quot;/lqrrt/path&quot;</span><span class="p">)</span>
    <span class="n">tree_topic</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~tree_topic&quot;</span><span class="p">,</span> <span class="s2">&quot;/lqrrt/tree&quot;</span><span class="p">)</span>
    <span class="n">goal_topic</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~goal_topic&quot;</span><span class="p">,</span> <span class="s2">&quot;/lqrrt/goal&quot;</span><span class="p">)</span>
    <span class="n">focus_topic</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~focus_topic&quot;</span><span class="p">,</span> <span class="s2">&quot;/lqrrt/focus&quot;</span><span class="p">)</span>
    <span class="n">effort_topic</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~effort_topic&quot;</span><span class="p">,</span> <span class="s2">&quot;/lqrrt/effort&quot;</span><span class="p">)</span>
    <span class="n">sampspace_topic</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~sampspace_topic&quot;</span><span class="p">,</span> <span class="s2">&quot;/lqrrt/sampspace&quot;</span><span class="p">)</span>
    <span class="n">guide_topic</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~guide_topic&quot;</span><span class="p">,</span> <span class="s2">&quot;/lqrrt/guide&quot;</span><span class="p">)</span>

    <span class="n">better_than_Astar</span> <span class="o">=</span> <span class="n">LQRRT_Node</span><span class="p">(</span>
        <span class="n">odom_topic</span><span class="p">,</span>
        <span class="n">ref_topic</span><span class="p">,</span>
        <span class="n">move_topic</span><span class="p">,</span>
        <span class="n">path_topic</span><span class="p">,</span>
        <span class="n">tree_topic</span><span class="p">,</span>
        <span class="n">goal_topic</span><span class="p">,</span>
        <span class="n">focus_topic</span><span class="p">,</span>
        <span class="n">effort_topic</span><span class="p">,</span>
        <span class="n">ogrid_topic</span><span class="p">,</span>
        <span class="n">ogrid_threshold</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
</pre></div>

            </main>
        </div>
    </body>
</html>